<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Where Anti-Asian Hate Happens</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/scrollama"></script>
  <style>
    body {
      margin: 0;
      font-family: Georgia, "Times New Roman", Times, serif;
      background-color: #000;
      color: #fff;
      overflow: hidden;
    }

    #container {
      display: flex;
      height: 100vh;
    }

    #scrolly {
      width: 40%;
      overflow-y: scroll;
      padding: 60px 30px;
      background: #000;
    }

    .step {
      margin-bottom: 100vh;
      min-height: 60vh;
      font-size: 18px;
      line-height: 1.5;
    }

    #graphic {
      width: 60%;
      position: sticky;
      top: 0;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(to bottom, #111, #000);
    }

    svg {
      width: 100%;
      height: 100%;
    }

    .tooltip {
    position: absolute;
    padding: 6px 10px;
    background: white;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 12px;
    pointer-events: none;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    opacity: 0;
    transition: opacity 0.2s;
    color: #000;
    }

    text.race-label {
      font-size: 10px;
      fill: #ccc;
    }

    .axis text {
        fill: #aaa;
        font-size: 6px;
    }

    .axis path, .axis line {
        stroke: #444;
        stroke-width: 1;
        }

    .message-overlay {
      position: absolute;
      top: 50%;
      left: 20%;
      transform: translate(-50%, -50%);
      font-size: 80px;
      line-height: 1.2;
      text-align: left;
      color: rgba(255, 255, 255, 0.3);
      pointer-events: none;
      z-index: 10;
      max-width: 600px;
      opacity: 0;
      transition: opacity 1.5s ease, transform 1.5s ease;
      font-family: Georgia, "Times New Roman", Times, serif;
    }

    .message-overlay.visible {
      opacity: 1;
      transform: translate(-50%, -60%);
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="scrolly">
      <div class="step">
        <h2>Trends in Anti-Asian Hate Crimes</h2>
        <p>While anti-Asian hate crimes surged during the COVID-19 pandemic, the number has remained elevated even after the pandemic subsided, compared to pre-COVID levels.</p>
      </div>
      <div class="step">
        <h2>Per Capita Comparison</h2>
        <p>When adjusted for population, recent rates of anti-Asian hate crimes have surpassed those of anti-Hispanic incidents. Though often overlooked, anti-Asian hate crimes are a real and persistent issue.</p>
      </div>
      <div class="step">
        <h2>Victim Sex Distribution</h2>
        <p>The gender breakdown of victims is similar across major racial and ethnic groups: around 60% of victims are male and approximately 30% are female.</p>
      </div>
      <div class="step">
        <h2>Victim Age Distribution</h2>
        <p>The age distribution of victims also shows little variation across groups, with individuals in their late teens to mid-30s being the most frequently targeted.</p>
      </div>
      <div class="step">
        <h2>Where Hate Happens</h2>
        <p>Anti-Asian hate crimes are less likely to occur in residences or schools, and more likely to happen in commercial areas and on roadsâ€”highlighting their vulnerability in public spaces.</p>
      </div>
      <div class="step">
        <h2>Victim-Offender Relationship</h2>
        <p>Asian victims are more frequently targeted by strangers compared to other groups.</p>
      </div>
    </div>
    <div id="graphic">
      <svg></svg>
    </div>
  </div>

  <div class="tooltip" id="tooltip"></div>

  <div class="message-overlay" id="message-overlay">
    <span id="message-text"></span>
  </div>

  <script>
    const svg = d3.select("svg");
    const colorSex = d3.scaleOrdinal()
        .domain(["Female", "Male", "Unknown"])
        .range(["#a78bfa", "#34d399", "#9ca3af"]);
    const width = 800, height = 600;
    const margin = { top: 60, right: 30, bottom: 80, left: 80 };
    const barWidth = width - margin.left - margin.right;
    const barHeight = height - margin.top - margin.bottom;

    const barLocation = svg.append("g").attr("id", "bar-location").style("opacity", 0);
    const barRelationship = svg.append("g").attr("id", "bar-relationship").style("opacity", 0);
    const sexPieGroup = svg.append("g").attr("id", "sex-pie-group").style("opacity", 0);
    // Create legend for sex pie chart (initially hidden)
    const legend = svg.append("g")
    .attr("id", "pie-legend")
    .attr("transform", `translate(${width - 180}, ${margin.top})`)
    .style("opacity", 0);

    ["Female", "Male", "Unknown"].forEach((label, i) => {
    const row = legend.append("g").attr("transform", `translate(0, ${i * 20})`);
    row.append("rect")
        .attr("width", 12)
        .attr("height", 12)
        .attr("fill", colorSex(label));
    row.append("text")
        .attr("x", 18)
        .attr("y", 10)
        .attr("fill", "#ccc")
        .style("font-size", "12px")
        .text(label);
    });
    const densityGroup = svg.append("g").attr("id", "density-group").style("opacity", 0);
    const tooltip = d3.select("#tooltip");
    const message = document.getElementById("message-overlay");
    const messages = {
      0: "Even after COVID, anti-Asian hate crimes remain elevated.",
      1: "Even after COVID, anti-Asian hate crimes remain elevated.",
      2: "Victims of hate crimes share similar gender characteristics.",
      3: "Victims of hate crimes share similar age characteristics.",
      4: "Asian people are more often targeted<br>by strangers in public spaces.",
      5: "Asian people are more often targeted<br>by strangers in public spaces."
    };

    const races = ["Anti-Black", "Anti-Asian", "Anti-Hispanic"];

    // Step 0: Line Chart for Yearly Trends
    const lineChart = svg.append("g").attr("id", "line-chart").style("opacity", 0);

    d3.csv("counts_by_year.csv", d3.autoType).then(data => {
    const x = d3.scaleBand().domain([...new Set(data.map(d => d.data_year))])
        .range([margin.left, width - margin.right]).padding(0.1);

    const y = d3.scaleLinear().domain([0, d3.max(data, d => d.count)]).nice()
        .range([height - margin.bottom, margin.top]);

    const color = d3.scaleOrdinal()
        .domain(["Anti-Asian", "Anti-Black", "Anti-Hispanic"])
        .range(["#ef4444", "#6b7280", "#a3a3a3"]);

    const groups = d3.groups(data, d => d.group);
    const line = d3.line()
        .x(d => x(d.data_year) + x.bandwidth() / 2)
        .y(d => y(d.count));

    const g = lineChart.append("g");

    g.selectAll("path")
        .data(groups)
        .join("path")
        .attr("fill", "none")
        .attr("stroke", d => color(d[0]))
        .attr("stroke-width", 2.5)
        .attr("d", d => line(d[1]));

    g.selectAll("circle")
        .data(data)
        .join("circle")
        .attr("cx", d => x(d.data_year) + x.bandwidth() / 2)
        .attr("cy", d => y(d.count))
        .attr("r", 4)
        .attr("fill", d => color(d.group))
        .on("mouseover", (event, d) => {
        tooltip.transition().style("opacity", 0.95);
        tooltip.html(`<strong>${d.group}</strong><br>Year: ${d.data_year}<br>Incidents: ${d.count}`)
            .style("left", `${event.pageX + 10}px`)
            .style("top", `${event.pageY - 28}px`);
        })
        .on("mouseout", () => tooltip.transition().style("opacity", 0));

    g.append("g")
        .attr("transform", `translate(0,${height - margin.bottom})`)
        .call(d3.axisBottom(x));

    g.append("g")
        .attr("transform", `translate(${margin.left},0)`)
        .call(d3.axisLeft(y));

    g.append("text")
        .attr("x", width / 2)
        .attr("y", margin.top - 30)
        .attr("text-anchor", "middle")
        .style("font-size", "18px")
        .style("fill", "#ccc")
        .text("Trends in Hate Crime by Group");
    });
    
    // --- Donut Pie Chart Data & Drawing ---
    const pieData = [
    {
        group: "Anti-Black",
        values: [
        { sex: "Female", value: 35 },
        { sex: "Male", value: 63 },
        { sex: "Unknown", value: 2 }
        ]
    },
    {
        group: "Anti-Asian",
        values: [
        { sex: "Female", value: 33 },
        { sex: "Male", value: 66 },
        { sex: "Unknown", value: 1 }
        ]
    },
    {
        group: "Anti-Hispanic",
        values: [
        { sex: "Female", value: 27 },
        { sex: "Male", value: 72 },
        { sex: "Unknown", value: 1 }
        ]
    }
    ];

    const radius = 80;
    const pie = d3.pie().value(d => d.value);
    const arc = d3.arc().innerRadius(30).outerRadius(radius);

    sexPieGroup.selectAll("*").remove();

    pieData.forEach((group, i) => {
    const g = sexPieGroup.append("g")
        .attr("transform", `translate(${160 + i * 220}, ${height / 2})`);

    const arcs = pie(group.values);

    g.selectAll("path")
        .data(arcs)
        .join("path")
        .attr("d", arc)
        .attr("fill", d => colorSex(d.data.sex))
        .on("mouseover", (event, d) => {
        tooltip.transition().style("opacity", 0.95);
        tooltip.html(`<strong>${group.group}</strong><br>${d.data.sex}: ${d.data.value}%`)
            .style("left", `${event.pageX + 10}px`)
            .style("top", `${event.pageY - 28}px`);
        })
        .on("mouseout", () => tooltip.transition().style("opacity", 0));

    g.append("text")
        .attr("y", radius + 20)
        .attr("text-anchor", "middle")
        .style("fill", "#ccc")
        .style("font-size", "14px")
        .text(group.group);
    });

    // Step 0: Location chart
    const lineChartPerCapita = svg.append("g").attr("id", "line-chart-percapita").style("opacity", 0);
    d3.csv("counts_per_100k.csv", d3.autoType).then(data => {
        const x = d3.scalePoint()
            .domain([...new Set(data.map(d => d.data_year))])
            .range([margin.left, width - margin.right]);

        const y = d3.scaleLinear()
            .domain([0, d3.max(data, d => d.per_100k)]).nice()
            .range([height - margin.bottom, margin.top]);

        const color = d3.scaleOrdinal()
            .domain(["Anti-Asian", "Anti-Black", "Anti-Hispanic"])
            .range(["#ef4444", "#6b7280", "#a3a3a3"]);

        const groups = d3.groups(data, d => d.group);
        const line = d3.line()
            .x(d => x(d.data_year))
            .y(d => y(d.per_100k));

        const g = lineChartPerCapita.append("g");

        g.selectAll("path")
            .data(groups)
            .join("path")
            .attr("fill", "none")
            .attr("stroke", d => color(d[0]))
            .attr("stroke-width", 2.5)
            .attr("d", d => line(d[1]));

        g.selectAll("circle")
            .data(data)
            .join("circle")
            .attr("cx", d => x(d.data_year))
            .attr("cy", d => y(d.per_100k))
            .attr("r", 4)
            .attr("fill", d => color(d.group))
            .on("mouseover", (event, d) => {
            tooltip.transition().style("opacity", 0.95);
            tooltip.html(`<strong>${d.group}</strong><br>Year: ${d.data_year}<br>Per 100k: ${d.per_100k.toFixed(2)}`)
                .style("left", `${event.pageX + 10}px`)
                .style("top", `${event.pageY - 28}px`);
            })
            .on("mouseout", () => tooltip.transition().style("opacity", 0));

        g.append("g")
            .attr("transform", `translate(0,${height - margin.bottom})`)
            .call(d3.axisBottom(x));

        g.append("g")
            .attr("transform", `translate(${margin.left},0)`)
            .call(d3.axisLeft(y));

        g.append("text")
            .attr("x", width / 2)
            .attr("y", margin.top - 30)
            .attr("text-anchor", "middle")
            .style("font-size", "18px")
            .style("fill", "#ccc")
            .text("Per Capita Hate Crime Trends");
        });

    // Step 0: Location chart
    const locationCategories = ["Residence", "School", "Commercial", "Road", "Other"];
    const colorMap = {
      highlightLow: "#3b82f6",
      highlightHigh: "#ef4444",
      others: "#666"
    };

    d3.csv("location_distribution.csv", d3.autoType).then(data => {
      const g = barLocation.append("g").attr("transform", `translate(${margin.left},${margin.top})`);
      const x0 = d3.scaleBand().domain(locationCategories).range([0, barWidth]).paddingInner(0.1);
      const x1 = d3.scaleBand().domain(races).range([0, x0.bandwidth()]).padding(0.05);
      const y = d3.scaleLinear().domain([0, 100]).range([barHeight, 0]);

      const categoryGroups = g.selectAll("g.category")
        .data(locationCategories)
        .join("g")
        .attr("class", "category")
        .attr("transform", d => `translate(${x0(d)},0)`);

      categoryGroups.each(function(category) {
        const group = d3.select(this);
        const bars = races.map(r => {
          const row = data.find(row => row.Race === r);
          return {
            category,
            race: r,
            value: row && !isNaN(row[category]) ? +row[category] : 0
          };
        });

        group.selectAll("rect")
          .data(bars)
          .join("rect")
          .attr("x", d => x1(d.race))
          .attr("y", y(0))
          .attr("width", x1.bandwidth())
          .attr("height", 0)
          .attr("rx", 4)
          .attr("fill", d => {
            if (d.race === "Anti-Asian" && ["Residence", "School"].includes(d.category)) return colorMap.highlightLow;
            if (d.race === "Anti-Asian" && ["Commercial", "Road"].includes(d.category)) return colorMap.highlightHigh;
            return colorMap.others;
          })
          .on("mouseover", (event, d) => {
            tooltip.transition().style("opacity", 0.95);
            tooltip.html(`<strong>${d.race.replace("Anti-", "")}</strong><br>${d.category}: ${d.value.toFixed(1)}%`)
              .style("left", `${event.pageX + 10}px`)
              .style("top", `${event.pageY - 28}px`);
          })
          .on("mouseout", () => tooltip.transition().style("opacity", 0))
          .transition()
          .duration(1000)
          .delay((_, i) => i * 100)
          .ease(d3.easeCubicOut)
          .attr("y", d => y(d.value))
          .attr("height", d => barHeight - y(d.value));

        group.selectAll("text.race-label")
          .data(bars)
          .join("text")
          .attr("class", "race-label")
          .attr("x", d => x1(d.race) + x1.bandwidth() / 2)
          .attr("y", barHeight + 12)
          .attr("text-anchor", "middle")
          .text(d => d.race.replace("Anti-", ""));
      });

      g.append("g")
        .attr("transform", `translate(0,${barHeight})`)
        .call(d3.axisBottom(x0));

      g.append("g")
        .call(d3.axisLeft(y).ticks(10).tickFormat(d => `${d}%`));

      g.append("text")
        .attr("x", barWidth / 2)
        .attr("y", -30)
        .attr("text-anchor", "middle")
        .style("font-size", "18px")
        .style("fill", "#ccc")
        .text("Locations of Hate Crimes");
    });

    // --- Age Density Chart Drawing ---
    d3.csv("age_density_by_race.csv", d3.autoType).then(data => {
    const x = d3.scaleLinear()
        .domain(d3.extent(data, d => d.age))
        .range([margin.left, width - margin.right]);

    const y = d3.scaleLinear()
        .domain([0, d3.max(data, d => d.density)]).nice()
        .range([height - margin.bottom, margin.top]);

    const color = d3.scaleOrdinal()
        .domain(["Anti-Asian", "Anti-Black", "Anti-Hispanic"])
        .range(["#ef4444", "#6b7280", "#a3a3a3"]);

    const line = d3.line()
        .x(d => x(d.age))
        .y(d => y(d.density))
        .curve(d3.curveBasis); // smooth curve

    const grouped = d3.groups(data, d => d.race_label);

    const g = densityGroup.append("g");

    g.selectAll("path")
        .data(grouped)
        .join("path")
        .attr("fill", "none")
        .attr("stroke", d => color(d[0]))
        .attr("stroke-width", 2.5)
        .attr("d", d => line(d[1]));

    g.append("g")
        .attr("transform", `translate(0,${height - margin.bottom})`)
        .call(d3.axisBottom(x));

    g.append("g")
        .attr("transform", `translate(${margin.left},0)`)
        .call(d3.axisLeft(y));

    g.append("text")
        .attr("x", width / 2)
        .attr("y", margin.top - 30)
        .attr("text-anchor", "middle")
        .style("font-size", "18px")
        .style("fill", "#ccc")
        .text("Victim Age Distribution");
    });

    // Step 1: Relationship chart
    d3.csv("relationship_distribution.csv", d3.autoType).then(data => {
      const g = barRelationship.append("g").attr("transform", `translate(${margin.left},${margin.top})`);
      const categories = ["Acquaintance", "Stranger", "Unknown"];
      const x0 = d3.scaleBand().domain(categories).range([0, barWidth]).paddingInner(0.1);
      const x1 = d3.scaleBand().domain(races).range([0, x0.bandwidth()]).padding(0.05);
      const y = d3.scaleLinear().domain([0, 100]).range([barHeight, 0]);

      const categoryGroups = g.selectAll("g.category")
        .data(categories)
        .join("g")
        .attr("class", "category")
        .attr("transform", d => `translate(${x0(d)},0)`);

      categoryGroups.each(function(category) {
        const group = d3.select(this);
        const bars = races.map(r => {
          const row = data.find(row => row.bias_group === r);
          return {
            category,
            race: r,
            value: row && !isNaN(row[category]) ? +row[category] : 0
          };
        });

        group.selectAll("rect")
          .data(bars)
          .join("rect")
          .attr("x", d => x1(d.race))
          .attr("y", y(0))
          .attr("width", x1.bandwidth())
          .attr("height", 0)
          .attr("rx", 4)
          .attr("fill", d => {
            if (d.race === "Anti-Asian" && d.category === "Acquaintance") return "#3b82f6";
            if (d.race === "Anti-Asian" && d.category === "Stranger") return "#ef4444";
            return "#666";
          })
          .on("mouseover", (event, d) => {
            tooltip.transition().style("opacity", 0.95);
            tooltip.html(`<strong>${d.race.replace("Anti-", "")}</strong><br>${d.category}: ${d.value.toFixed(1)}%`)
              .style("left", `${event.pageX + 10}px`)
              .style("top", `${event.pageY - 28}px`);
          })
          .on("mouseout", () => tooltip.transition().style("opacity", 0))
          .transition()
          .duration(1000)
          .delay((_, i) => i * 100)
          .ease(d3.easeCubicOut)
          .attr("y", d => y(d.value))
          .attr("height", d => barHeight - y(d.value));

        group.selectAll("text.race-label")
          .data(bars)
          .join("text")
          .attr("class", "race-label")
          .attr("x", d => x1(d.race) + x1.bandwidth() / 2)
          .attr("y", barHeight + 12)
          .attr("text-anchor", "middle")
          .text(d => d.race.replace("Anti-", ""));
      });

      g.append("g")
        .attr("transform", `translate(0,${barHeight})`)
        .call(d3.axisBottom(x0));

      g.append("g")
        .call(d3.axisLeft(y).ticks(10).tickFormat(d => `${d}%`));

      g.append("text")
        .attr("x", barWidth / 2)
        .attr("y", -30)
        .attr("text-anchor", "middle")
        .style("font-size", "18px")
        .style("fill", "#ccc")
        .text("Victim-Offender Relationship");
    });

    // Step-based chart and text transitions
    function transitionTo(step) {
        lineChart.transition().duration(1200).style("opacity", step === 0 ? 1 : 0);        
        lineChartPerCapita.transition().duration(1200).style("opacity", step === 1 ? 1 : 0);
        sexPieGroup.transition().duration(1200).style("opacity", step === 2 ? 1 : 0);
        d3.select("#pie-legend").transition().duration(1200).style("opacity", step === 2 ? 1 : 0);
        densityGroup.transition().duration(1200).style("opacity", step === 3 ? 1 : 0);
        barLocation.transition().duration(1200).style("opacity", step === 4 ? 1 : 0);
        barRelationship.transition().duration(1200).style("opacity", step === 5 ? 1 : 0);

        const messageText = document.getElementById("message-text");
    const currentMessage = messages[step];
    const prevMessage = messageText.innerHTML;
    
    if (currentMessage && currentMessage !== prevMessage) {
      message.classList.remove("visible");
      setTimeout(() => {
        messageText.innerHTML = currentMessage;
        message.classList.add("visible");
      }, 300);
    } else if (!currentMessage) {
      message.classList.remove("visible");
    }
    }

    const scroller = scrollama();
    scroller.setup({ step: ".step", offset: 0.5 })
      .onStepEnter(response => transitionTo(response.index));
  </script>
</body>
</html>